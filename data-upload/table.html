<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>Upload CSV</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.18/dgrid/css/dgrid.css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.18/dojox/grid/resources/claroGrid.css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.18/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.18/"></script>
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .container {
        height: 100%;
        width: 100%;
      }

        #info,
        #gridDisplay {
        position: absolute;
        bottom: 0;
        top: 15px;
        left: 0;
        height: 35%;
        background-color: white;
        border-color: grey;
        width: 100%;
        font-size: 14px;
        margin: 2px;
        }

        #gridDisplay {
        z-index: 80;
        }

        #info {
        z-index: 90;
        font-size: 16px;
        padding-left: 20px;
        }

        #info * {
        padding-right: 20px;
        }

        .info {
        line-height: 20px;
        padding-left: 5px !important;
        }

        .dgrid-header,
        .dgrid-header-row {
        background-color: #eee;
        color: #57585a;
        }

        .dgrid-row-even {
        background-color: #f7f8f8;
        }

        .dgrid-row-odd {
        background-color: #efefef;
        }

        .dgrid-selected {
        background: #b4daf5;
        }

        .dgrid-row {
        border: none;
        }

        /*Grid needs an explicit height by default*/
        #tableDiv {
            height: 20em;
        }           
    </style>
    <script>
      require([
        "esri/layers/FeatureLayer",
        "esri/widgets/FeatureTable",
        "dojo/_base/array",
        "dojo/_base/lang",
        "dojox/data/CsvStore",
        "dojox/grid/DataGrid",
		"dojox/grid/cells",
		"dojox/grid/cells/dijit"
      ], function(FeatureLayer, FeatureTable, arrayUtils, lang, CsvStore, DataGrid, cells, cellsDijit) {
        /*create a new grid*/
        var readWriteStore = null;
        // var layout = [[
        //     {'name': 'ObjectId', 'field': 'ObjectId', 'width': '100px'},
        //     {'name': 'Fed ID', 'field': 'Fed ID', 'width': '100px'},
        //     {'name': 'District Code', 'field': 'District Code', 'width': '200px'},
        //     {'name': 'CDS Code', 'field': 'CDS Code', 'width': '200px'},
        //     {'name': 'County Name', 'field': 'County Name', 'width': '200px'},
        //     {'name': 'District Name', 'field': 'District Name', 'width': '200px'},
        //     {'name': 'District Type', 'field': 'District Type', 'width': '200px'},
        //     {'name': 'Elementary Status', 'field': 'Elementary Status', 'width': '200px', editable: true},
        //     {'name': 'Middle Status', 'field': 'Middle Status', 'width': '200px', editable: true},
        //     {'name': 'High Status', 'field': 'High Status', 'width': '200px', editable: true},
        //     {'name': 'Safety Plan', 'field':'Safety Plan Submitted', 'width': '100px', editable: true},
        //     {'name': 'Link', 'field': 'Safety Plan Link', 'width': '200px', editable: true}
        //     ]];

        var layout = [{
            defaultCell: { width: 8, editable: true, type: cells._Widget, styles: 'text-align: right;'  },
            cells:[
            { name: 'Id', field: 'id', editable: false, width: 2 /* Can't edit ID's of dojo/store items */ },    
            {'name': 'ObjectId', 'field': 'ObjectId', 'width': '100px', editable: false, },
            {'name': 'Fed ID', 'field': 'Fed ID', 'width': '100px', editable: false, },
            {'name': 'District Code', 'field': 'District Code', 'width': '200px', editable: false, },
            {'name': 'CDS Code', 'field': 'CDS Code', 'width': '200px', editable: false, },
            {'name': 'County Name', 'field': 'County Name', 'width': '200px', editable: false, },
            {'name': 'District Name', 'field': 'District Name', 'width': '200px', editable: false, },
            {'name': 'District Type', 'field': 'District Type', 'width': '200px', editable: false, },
            {'name': 'Elementary Status', 'field': 'Elementary Status', 'width': '200px', editable: true},
            {'name': 'Middle Status', 'field': 'Middle Status', 'width': '200px', editable: true},
            {'name': 'High Status', 'field': 'High Status', 'width': '200px', editable: true},
            {'name': 'Safety Plan', 'field':'Safety Plan Submitted', 'width': '100px', editable: true},
            {'name': 'Link', 'field': 'Safety Plan Link', 'width': '200px', editable: true}
            ]
        }];
        var grid = new DataGrid({
            id: 'grid',
            structure: layout,
            rowSelector: '20px'});

        /*append the new grid to the div*/
        grid.placeAt("tableDiv");

        /*Call startup() to render the grid*/
        grid.startup();
        

        document.getElementById('divUpload').addEventListener('change', upload, false);

        function checkBrowserCompatibility() {
            var compatible = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                compatible = true;
            }
            return compatible;
        }
        
        function handleCSV (file) {
            console.log("Processing CSV: ", file, ", ", file.name, ", ", file.type, ", ", file.size);
            if (file.data) {
                var decoded = bytesToString(base64.decode(file.data));
                processCSVData(decoded);
            }
            else {
                var reader = new FileReader();
                reader.onload = function () {
                console.log("Finished reading CSV data");
                processCSVData(reader.result);
                };
                reader.readAsText(file);
            }
        }

        var bytesToString = function (b) {
            console.log("bytes to string");
            var s = [];
            arrayUtils.forEach(b, function (c) {
                s.push(String.fromCharCode(c));
            });
            return s.join("");
        };

        function processCSVData (data) {
            var newLineIndex = data.indexOf("\n");
            var firstLine = data.substr(0, newLineIndex); //remove extra whitespace, not sure if I need to do this since I threw out space delimiters
            var separator = getSeparator(firstLine); 
            var csvStore = new CsvStore({
                data: data,
                separator: separator
            });
            var rw_data = {
                identifier:"id",
                items:[]
            }
            // for(var i=0; i<csvStore.data.items.length; i++){
            //     var item = csvStore.data.items[i]
            //     var attrs = csvStore.getAttributes(item)
            //     rw_data.items.push(dojo.mixin({ id: i+1 }, data_list[i%l]));
            // }
            //readWriteStore = new dojo.data.ItemFileWriteStore({data: rw_data});
            grid.setStore(csvStore);
        }

        function getSeparator (string) {
            var separators = [",", "      ", ";", "|"];
            var maxSeparatorLength = 0;
            var maxSeparatorValue = "";
            arrayUtils.forEach(separators, function (separator) {
                var length = string.split(separator).length;
                if (length > maxSeparatorLength) {
                maxSeparatorLength = length;
                maxSeparatorValue = separator;
                }
            });
            return maxSeparatorValue;
        }

        function upload(evt) {
            if (!checkBrowserCompatibility()) {
                alert('The File APIs are not fully supported in this browser!');
                } else {
                    var data = null;
                    var file = evt.target.files[0];
                    handleCSV(file)
                }                
            }
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div id="tableDiv"></div>
        <div id="divUploadContainer" class="fileupload ">
            <fieldset>
                <legend>Upload CSV File</legend>
                    <input type="file" name="File Upload" id="divUpload" accept=".csv" />
           </fieldset>
        </div>
    </div>
  </body>
</html>
